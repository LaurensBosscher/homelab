---
- name: Gather facts (ensures memory facts are available)
  ansible.builtin.setup:
    filter: ansible_memtotal_mb
  tags: [optimizations]

- name: Set memory-related variables
  ansible.builtin.set_fact:
    total_mem_kb: "{{ ansible_memtotal_mb * 1024 | int }}"
    total_mem_gb: "{{ ansible_memtotal_mb // 1024 | int }}"
    k8s_low_mem_threshold_gb: 12
  tags: [optimizations]

- name: Calculate dynamic min_free_kbytes 512 MB
  ansible.builtin.set_fact:
    vm_min_free_kbytes: 524288
  tags: [optimizations]

- name: Set vm parameters for low-memory systems (< 12 GB)
  ansible.builtin.set_fact:
    vm_swappiness: "60"
    vm_dirty_ratio: "10"
    vm_dirty_background_ratio: "3"
    queue_depth: "32"
  when: total_mem_gb | int < k8s_low_mem_threshold_gb | int
  tags: [optimizations]

- name: Set vm parameters for normal/high-memory systems (>= 12 GB)
  ansible.builtin.set_fact:
    vm_swappiness: "60"
    vm_dirty_ratio: "15"
    vm_dirty_background_ratio: "5"
    queue_depth: "256"
  when: total_mem_gb | int >= k8s_low_mem_threshold_gb | int
  tags: [optimizations]

- name: Install tuned
  ansible.builtin.dnf:
    name: tuned
    state: present
  become: true
  tags: [optimizations]

- name: Enable and start tuned
  ansible.builtin.systemd:
    name: tuned
    enabled: true
    state: started
  become: true
  tags: [optimizations]

- name: Create directory for custom tuned profile
  ansible.builtin.file:
    path: /etc/tuned/kubernetes-node
    state: directory
    mode: "0755"
  become: true
  tags: [optimizations]

# Use a custom tuned profile instead of throughput-performance + manual overrides
- name: Create custom tuned profile for Kubernetes nodes
  ansible.builtin.copy:
    dest: /etc/tuned/kubernetes-node/tuned.conf
    mode: "0644"
    content: |
      [main]
      include=virtual-guest   # or throughput-performance as base if you prefer

      [sysctl]
      vm.swappiness = {{ vm_swappiness }}
      vm.dirty_ratio = {{ vm_dirty_ratio }}
      vm.dirty_background_ratio = {{ vm_dirty_background_ratio }}
      vm.vfs_cache_pressure = 50
      vm.min_free_kbytes = {{ vm_min_free_kbytes }}
      vm.dirty_expire_centisecs = 3000
      vm.dirty_writeback_centisecs = 500
      vm.watermark_scale_factor = 200
      vm.page-cluster = 0

      [vm]
      transparent_hugepages = never
  become: true
  tags: [optimizations]
  notify: activate kubernetes-node profile

- name: Determine root block device (more reliable than grep sd*)
  ansible.builtin.set_fact:
    root_block_device: >-
      {{ ansible_mounts
         | selectattr('mount', 'equalto', '/')
         | map(attribute='device')
         | map('regex_replace', '^/dev/(.*)', '\1')
         | first }}
  tags: [optimizations]

- name: Set I/O scheduler to mq-deadline (or bfq for SSD if you want)
  ansible.posix.sysctl:
    name: block.{{ root_block_device }}.queue.scheduler
    value: mq-deadline
    state: present
    sysctl_file: /etc/sysctl.d/99-kubernetes-optimizations.conf
    reload: true
  become: true
  ignore_errors: true # some kernels don't expose it this way
  tags: [optimizations]

- name: Persist read_ahead_kb = 4096 and nr_requests via udev (recommended way)
  ansible.builtin.copy:
    dest: /etc/udev/rules.d/99-kubernetes-io.rules
    mode: "0644"
    content: |
      ACTION=="add|change", KERNEL=="{{ root_block_device }}", ATTR{queue/scheduler}="mq-deadline"
      ACTION=="add|change", KERNEL=="{{ root_block_device }}", ATTR{queue/read_ahead_kb}="4096"
      ACTION=="add|change", KERNEL=="{{ root_block_device }}", ATTR{queue/nr_requests}="{{ queue_depth }}"
    owner: root
  become: true
  register: udev_rules
  tags: [optimizations]

- name: Apply udev rules now (without reboot)
  ansible.builtin.shell: udevadm control --reload-rules && udevadm trigger
  become: true
  when: udev_rules.changed
  tags: [optimizations]

- name: Add noatime to root filesystem in fstab (safest persistent way)
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '(\s+/+\s+{{ ansible_mounts | selectattr("mount","equalto","/") | map(attribute="fstype") | first }}\s+.*\s)(defaults)(,)'
    replace: '\1defaults,noatime\3'
  become: true
  register: fstab_noatime
  tags: [optimizations]

- name: Remount root with noatime if fstab changed
  ansible.builtin.mount:
    path: /
    state: remounted
  become: true
  when: fstab_noatime.changed
  tags: [optimizations]
