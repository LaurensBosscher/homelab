---
- name: Check if Tailscale is already installed
  ansible.builtin.stat:
    path: /usr/bin/tailscale
  register: tailscale_binary
  tags: [tailscale]

- name: Download Tailscale install script
  ansible.builtin.get_url:
    url: https://tailscale.com/install.sh
    dest: /tmp/tailscale-install.sh
    mode: "0755"
  when: not tailscale_binary.stat.exists
  become: true
  tags: [tailscale]

- name: Install Tailscale
  ansible.builtin.command: /tmp/tailscale-install.sh
  when: not tailscale_binary.stat.exists
  become: true
  register: tailscale_install
  tags: [tailscale]

- name: Clean up install script
  ansible.builtin.file:
    path: /tmp/tailscale-install.sh
    state: absent
  when: not tailscale_binary.stat.exists
  tags: [tailscale]

- name: Enable and start Tailscale service
  ansible.builtin.systemd:
    name: tailscaled
    state: started
    enabled: true
  tags: [tailscale]

- name: Create udev rule for Tailscale MTU
  ansible.builtin.copy:
    content: |
      ACTION=="add", SUBSYSTEM=="net", KERNEL=="tailscale0", RUN+="/sbin/ip link set dev tailscale0 mtu {{ tailscale_mtu | default(1280) }}"
    dest: /etc/udev/rules.d/99-tailscale-mtu.rules
    mode: "0644"
  become: true
  tags: [tailscale]

- name: Check if udev rules need reloading
  ansible.builtin.stat:
    path: /etc/udev/rules.d/99-tailscale-mtu.rules
  register: tailscale_udev_rule
  tags: [tailscale]

- name: Reload udev rules
  ansible.builtin.command: udevadm control --reload-rules
  become: true
  when: tailscale_udev_rule.stat.exists
  tags: [tailscale]

- name: Trigger udev rules for network subsystem
  ansible.builtin.command: udevadm trigger --subsystem-match=net --action=add
  become: true
  when: tailscale_udev_rule.stat.exists
  tags: [tailscale]

- name: Enable IP forwarding for Tailscale
  ansible.builtin.lineinfile:
    path: /etc/sysctl.d/99-tailscale.conf
    line: "{{ item }}"
    create: true
    mode: "0644"
  become: true
  loop:
    - "net.ipv4.ip_forward = 1"
    - "net.ipv6.conf.all.forwarding = 1"
  tags: [tailscale]

- name: Apply sysctl configuration
  ansible.builtin.command: sysctl -p /etc/sysctl.d/99-tailscale.conf
  become: true
  tags: [tailscale]
