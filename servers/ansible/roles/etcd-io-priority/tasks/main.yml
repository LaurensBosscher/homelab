---
- name: Install ionice utility (util-linux package)
  ansible.builtin.dnf:
    name: util-linux
    state: present

- name: Create systemd drop-in directory for k3s
  ansible.builtin.file:
    path: /etc/systemd/system/k3s.service.d
    state: directory
    mode: "0755"

- name: Configure IO priority for etcd process (native systemd)
  ansible.builtin.copy:
    dest: /etc/systemd/system/k3s.service.d/etcd-io-priority.conf
    content: |
      [Service]
      # Set highest IO priority for etcd process (embedded in k3s)
      # Real-time IO scheduling class (1) with highest priority (0)
      IOSchedulingClass=realtime
      IOSchedulingPriority=0
    mode: "0644"
  notify: reload and restart k3s

- name: Remove legacy etcd IO priority monitoring script
  ansible.builtin.file:
    path: /usr/local/bin/etcd-io-priority-check.sh
    state: absent

- name: Remove legacy etcd IO priority check timer
  ansible.builtin.systemd:
    name: etcd-io-priority-check.timer
    state: stopped
    enabled: no
  ignore_errors: true

- name: Remove legacy etcd IO priority check timer file
  ansible.builtin.file:
    path: /etc/systemd/system/etcd-io-priority-check.timer
    state: absent

- name: Remove legacy etcd IO priority check service file
  ansible.builtin.file:
    path: /etc/systemd/system/etcd-io-priority-check.service
    state: absent
  notify: reload and restart k3s
