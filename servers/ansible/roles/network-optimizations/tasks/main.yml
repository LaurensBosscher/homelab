---
- name: Get primary network interface
  ansible.builtin.set_fact:
    primary_network_interface: >-
      {{
        ansible_default_ipv4.interface
          | default(ansible_default_ipv6.interface | default(''))
      }}
  when: network_optimizations_enable | default(true)
  tags: [network-optimizations]

- name: Ensure detected network interface exists
  ansible.builtin.stat:
    path: "/sys/class/net/{{ primary_network_interface }}"
  register: primary_interface_path
  when:
    - network_optimizations_enable | default(true)
    - primary_network_interface | length > 0
  tags: [network-optimizations]

- name: Check ethtool availability
  ansible.builtin.command:
    argv: ["ethtool", "--version"]
  register: ethtool_check
  changed_when: false
  failed_when: false
  when: network_optimizations_enable | default(true)
  tags: [network-optimizations]

- name: Read current network interface features
  ansible.builtin.command:
    argv: ["ethtool", "-k", "{{ primary_network_interface }}"]
  register: current_ethtool_features
  changed_when: false
  failed_when: false
  when:
    - network_optimizations_enable | default(true)
    - primary_network_interface | length > 0
    - primary_interface_path.stat.exists
    - ethtool_check.rc == 0
  tags: [network-optimizations]

- name: Define desired ethtool feature states
  ansible.builtin.set_fact:
    network_ethtool_features:
      - { cmd: "tx-udp-segmentation", check: "tx-udp-segmentation", state: "on" }
      - { cmd: "rx-udp-gro-forwarding", check: "rx-udp-gro-forwarding", state: "on" }
      - { cmd: "rx-gro-list", check: "rx-gro-list", state: "off" }
      - { cmd: "tx-checksum-ip-generic", check: "tx-checksum-ip-generic", state: "on" }
      - { cmd: "rx-checksum", check: "rx-checksumming", state: "on" }
  when: network_optimizations_enable | default(true)
  tags: [network-optimizations]

- name: Apply ethtool feature optimizations when needed
  ansible.builtin.command:
    argv:
      - ethtool
      - -K
      - "{{ primary_network_interface }}"
      - "{{ item.cmd }}"
      - "{{ item.state }}"
  register: ethtool_optimize
  changed_when: ethtool_optimize.rc == 0
  failed_when: >-
    ethtool_optimize.rc != 0 and
    (ethtool_optimize.stderr | default('')) is not search('Operation not supported|Cannot change|Invalid argument|not supported')
  become: true
  loop: "{{ network_ethtool_features }}"
  when:
    - network_optimizations_enable | default(true)
    - primary_network_interface | length > 0
    - primary_interface_path.stat.exists
    - ethtool_check.rc == 0
    - current_ethtool_features.rc == 0
    - "{{ (item.check ~ ':') in current_ethtool_features.stdout }}"
    - "{{ current_ethtool_features.stdout is not search(item.check ~ ':.*\\[fixed\\]') }}"
    - "{{ (item.check ~ ': ' ~ ('off' if item.state == 'on' else 'on')) in current_ethtool_features.stdout }}"
  tags: [network-optimizations]

- name: Check available TCP congestion controls
  ansible.builtin.command:
    argv: ["sysctl", "-n", "net.ipv4.tcp_available_congestion_control"]
  register: tcp_cc_available
  changed_when: false
  failed_when: false
  when: network_optimizations_enable | default(true)
  tags: [network-optimizations]

- name: Apply network kernel parameters for 1Gbps optimization
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-network-optimizations.conf
    reload: true
  become: true
  loop:
    - { name: "net.core.rmem_max", value: "16777216" }
    - { name: "net.core.wmem_max", value: "16777216" }
    - { name: "net.core.rmem_default", value: "8388608" }
    - { name: "net.ipv4.udp_rmem_min", value: "16384" }
    - { name: "net.core.netdev_budget", value: "1200" }
    - { name: "net.ipv4.tcp_congestion_control", value: "bbr" }
    - { name: "net.ipv4.tcp_keepalive_time", value: "60" }
    - { name: "net.ipv4.tcp_keepalive_intvl", value: "10" }
    - { name: "net.ipv4.tcp_keepalive_probes", value: "6" }
    - { name: "net.ipv4.tcp_window_scaling", value: "1" }
    - { name: "net.ipv4.tcp_timestamps", value: "1" }
    - { name: "net.ipv4.tcp_sack", value: "1" }
  when:
    - network_optimizations_enable | default(true)
    - item.name != 'net.ipv4.tcp_congestion_control' or ('bbr' in (tcp_cc_available.stdout | default('')))
  tags: [network-optimizations]

- name: Install persistent network optimization script
  ansible.builtin.copy:
    dest: /usr/local/sbin/network-interface-optimizations
    mode: "0755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      iface="${1:-}"

      if [[ -z "${iface}" || ! -e "/sys/class/net/${iface}" ]]; then
        exit 0
      fi

      if ! command -v ethtool >/dev/null 2>&1; then
        exit 0
      fi

      features="$(ethtool -k "${iface}" 2>/dev/null || true)"
      if [[ -z "${features}" ]]; then
        exit 0
      fi

      apply_feature() {
        local cmd_feature="$1"
        local check_feature="$2"
        local desired_state="$3"
        local current_state
        local target_state
        local output

        if ! grep -q "${check_feature}:" <<<"${features}"; then
          return 0
        fi

        if grep -Eq "${check_feature}:.*\[fixed\]" <<<"${features}"; then
          return 0
        fi

        if [[ "${desired_state}" == "on" ]]; then
          current_state="off"
          target_state="on"
        else
          current_state="on"
          target_state="off"
        fi

        if ! grep -q "${check_feature}: ${current_state}" <<<"${features}"; then
          return 0
        fi

        if ! output="$(ethtool -K "${iface}" "${cmd_feature}" "${target_state}" 2>&1)"; then
          if grep -Eq "Operation not supported|Cannot change|Invalid argument|not supported" <<<"${output}"; then
            return 0
          fi
          echo "${output}" >&2
          return 1
        fi
      }

      apply_feature "tx-udp-segmentation" "tx-udp-segmentation" "on"
      apply_feature "rx-udp-gro-forwarding" "rx-udp-gro-forwarding" "on"
      apply_feature "rx-gro-list" "rx-gro-list" "off"
      apply_feature "tx-checksum-ip-generic" "tx-checksum-ip-generic" "on"
      apply_feature "rx-checksum" "rx-checksumming" "on"
  become: true
  when: network_optimizations_enable | default(true)
  tags: [network-optimizations]

- name: Create systemd service to persist network interface optimizations
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Apply network interface optimizations after boot
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/network-interface-optimizations {{ primary_network_interface }}
      RemainAfterExit=true

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/network-interface-optimizations.service
    mode: "0644"
  become: true
  when:
    - network_optimizations_enable | default(true)
    - primary_network_interface | length > 0
    - primary_interface_path.stat.exists
  tags: [network-optimizations]

- name: Enable and start network interface optimizations service
  ansible.builtin.systemd:
    name: network-interface-optimizations
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when:
    - network_optimizations_enable | default(true)
    - primary_network_interface | length > 0
    - primary_interface_path.stat.exists
  tags: [network-optimizations]
