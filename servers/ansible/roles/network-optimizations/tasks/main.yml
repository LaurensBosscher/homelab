---
- name: Get primary network interface
  ansible.builtin.set_fact:
    primary_network_interface: "{{ ansible_default_ipv4.interface }}"
  tags: [network-optimizations]

- name: Check current network interface features
  ansible.builtin.command: ethtool -k {{ primary_network_interface }}
  register: current_ethtool_features
  changed_when: false
  failed_when: false
  when: primary_network_interface != ""
  tags: [network-optimizations]

- name: Apply network interface optimizations (tx-udp-segmentation)
  ansible.builtin.shell: ethtool -K {{ primary_network_interface }} tx-udp-segmentation on
  become: true
  when:
    - primary_network_interface != ""
    - current_ethtool_features.rc == 0
    - "'tx-udp-segmentation: off' in current_ethtool_features.stdout"
  register: tx_udp_segmentation
  changed_when: true
  ignore_errors: yes
  tags: [network-optimizations]

- name: Apply network interface optimizations (rx-udp-gro-forwarding)
  ansible.builtin.shell: ethtool -K {{ primary_network_interface }} rx-udp-gro-forwarding on
  become: true
  when:
    - primary_network_interface != ""
    - current_ethtool_features.rc == 0
    - "'rx-udp-gro-forwarding: off' in current_ethtool_features.stdout"
  register: rx_udp_gro_forwarding
  changed_when: true
  ignore_errors: yes
  tags: [network-optimizations]

- name: Apply network interface optimizations (rx-gro-list)
  ansible.builtin.shell: ethtool -K {{ primary_network_interface }} rx-gro-list off
  become: true
  when:
    - primary_network_interface != ""
    - current_ethtool_features.rc == 0
    - "'rx-gro-list: on' in current_ethtool_features.stdout"
  register: rx_gro_list
  changed_when: true
  ignore_errors: yes
  tags: [network-optimizations]

- name: Apply network interface optimizations (tx-checksum-ip-generic)
  ansible.builtin.shell: ethtool -K {{ primary_network_interface }} tx-checksum-ip-generic on
  become: true
  when:
    - primary_network_interface != ""
    - current_ethtool_features.rc == 0
    - "'tx-checksum-ip-generic: off' in current_ethtool_features.stdout"
  register: tx_checksum_ip_generic
  changed_when: true
  ignore_errors: yes
  tags: [network-optimizations]

- name: Apply network interface optimizations (rx-checksum)
  ansible.builtin.shell: ethtool -K {{ primary_network_interface }} rx-checksum on
  become: true
  when:
    - primary_network_interface != ""
    - current_ethtool_features.rc == 0
    - "'rx-checksum: off' in current_ethtool_features.stdout"
  register: rx_checksum
  changed_when: true
  ignore_errors: yes
  tags: [network-optimizations]

- name: Apply network kernel parameters for 1Gbps optimization
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-network-optimizations.conf
    reload: true
  become: true
  loop:
    - { name: "net.core.rmem_max", value: "16777216" }
    - { name: "net.core.wmem_max", value: "16777216" }
    - { name: "net.core.rmem_default", value: "8388608" }
    - { name: "net.ipv4.udp_rmem_min", value: "16384" }
    - { name: "net.core.netdev_budget", value: "1200" }
    - { name: "net.ipv4.tcp_congestion_control", value: "bbr" }
    - { name: "net.ipv4.tcp_keepalive_time", value: "60" }
    - { name: "net.ipv4.tcp_keepalive_intvl", value: "10" }
    - { name: "net.ipv4.tcp_keepalive_probes", value: "6" }
    # Multi-region WAN optimizations
    - { name: "net.ipv4.tcp_window_scaling", value: "1" }
    - { name: "net.ipv4.tcp_timestamps", value: "1" }
    - { name: "net.ipv4.tcp_sack", value: "1" }
  tags: [network-optimizations]

- name: Create systemd service to persist network interface optimizations
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Apply network interface optimizations after boot
      After=network.target

      [Service]
      Type=oneshot
      ExecStart=/bin/bash -c 'ethtool -K {{ primary_network_interface }} tx-udp-segmentation on rx-udp-gro-forwarding on rx-gro-list off tx-checksum-ip-generic on rx-checksum on || true'
      RemainAfterExit=true

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/network-interface-optimizations.service
    mode: "0644"
  become: true
  when: primary_network_interface != ""
  register: systemd_service_created
  tags: [network-optimizations]

- name: Enable network interface optimizations service
  ansible.builtin.systemd:
    name: network-interface-optimizations
    enabled: true
    daemon_reload: true
  become: true
  when: primary_network_interface != ""
  tags: [network-optimizations]
