---
- name: Configure host firewall (nftables)
  when: firewall_enable | bool
  tags: [firewall]
  block:
    - name: Stop and disable firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Mask firewalld to prevent accidental start
      ansible.builtin.systemd:
        name: firewalld
        masked: true
      ignore_errors: true

    - name: Build dynamic allowlists from inventory (eth0)
      ansible.builtin.set_fact:
        firewall_cluster_eth0_ips: >-
          {{ ((groups['kubernetes-control-plane'] | default([])) + (groups['kubernetes-agent'] | default([])))
             | map('extract', hostvars, 'eth0_ip')
             | select('defined')
             | list
             + ['84.226.19.128']
             | unique
             | list }}
        firewall_control_plane_eth0_ips: >-
          {{ (groups['kubernetes-control-plane'] | default([]))
             | map('extract', hostvars, 'eth0_ip')
             | select('defined')
             | unique
             | list
             + ['84.226.19.128']
             | unique
             | list }}
      tags: [firewall]

    - name: Deploy nftables configuration from template
      ansible.builtin.template:
        src: nftables.conf.j2
        dest: /etc/nftables.conf
        owner: root
        group: root
        mode: "0644"
        validate: nft -c -f %s
      notify: reload nftables
      tags: [firewall, config]

    - name: Ensure nftables service is enabled and started
      ansible.builtin.systemd:
        name: nftables
        enabled: false
        state: stopped
      tags: [firewall, persistence]
