---
- name: Set dotfiles_home fact when user provided
  ansible.builtin.set_fact:
    dotfiles_home: "{{ (dotfiles_user is defined and dotfiles_user != lookup('env','USER')) | ternary('/home/' + dotfiles_user, lookup('env','HOME')) }}"
  when: dotfiles_user is defined
  tags: [dotfiles]

- name: Default dotfiles_home to HOME if not set
  ansible.builtin.set_fact:
    dotfiles_home: "{{ lookup('env','HOME') if dotfiles_home is not defined else dotfiles_home }}"
  tags: [dotfiles]

- name: Deploy .bashrc
  ansible.builtin.copy:
    dest: "/root/.bashrc"
    content: |
      # .bashrc

      # Source global definitions
      if [ -f /etc/bashrc ]; then
          . /etc/bashrc
      fi

      # User specific environment
      if ! [[ "$PATH" =~ "$HOME/.local/bin:$HOME/bin:" ]]
      then
          PATH="$HOME/.local/bin:$HOME/bin:$PATH"
      fi
      export PATH

      # Uncomment the following line if you don't like systemctl's auto-paging feature:
      # export SYSTEMD_PAGER=

      # User specific aliases and functions

      # Kubernetes autocompletion for kubectl
      if command -v kubectl &> /dev/null; then
          source <(kubectl completion bash)
      fi

      # Make "kubecolor" borrow the same completion logic as "kubectl"
      complete -o default -F __start_kubectl kubecolor
      complete -o default -F __start_kubectl k

      # Default editor is nano
      export EDITOR=nano
      export VISUAL=nano

      # Aliases
      alias k='kubecolor'
      alias cat='bat'  # Assuming bat is installed; provides syntax highlighting for cat
      alias k9s='k9s --kubeconfig /etc/rancher/k3s/k3s.yaml'  # k9s with k3s kubeconfig
      alias kns='kubectl config set-context --current --namespace'  # Switch kubectl namespace

      # Enable color support for ls and grep (common tweak for better readability)
      if [ -x /usr/bin/dircolors ]; then
          test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
          alias ls='ls --color=auto'
          alias grep='grep --color=auto'
          alias fgrep='fgrep --color=auto'
          alias egrep='egrep --color=auto'
      fi
      GRC_ALIASES=true
      source /etc/profile.d/grc.sh 2>/dev/null || true

      # History settings for better session management
      HISTSIZE=10000
      HISTFILESIZE=20000
      HISTCONTROL=ignoreboth  # Ignore duplicates and lines starting with space
      shopt -s histappend    # Append to history instead of overwriting

      # Colored prompt (adjust PS1 as needed)
      if [ -x /usr/bin/tput ] && tput setaf 1 >&/dev/null; then
          PS1='\[\e[32m\]\u@\h \[\e[34m\]\w \[\e[0m\]\$ '
      else
          PS1='\u@\h:\w\$ '
      fi

      # Safety aliases to prevent accidental overwrites
      alias rm='rm -i'
      alias cp='cp -i'
      alias mv='mv -i'

      # Function to quickly update system (AlmaLinux/RHEL-based)
      update() {
          sudo dnf update -y && sudo dnf autoremove -y
      }

      # Set KUBECONFIG for k3s, required for helm
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

      # etcdctl configuration for K3s embedded etcd
      export ETCDCTL_ENDPOINTS="{% for host in groups['kubernetes-control-plane'] %}https://{{ hostvars[host]['ansible_eth0']['ipv4']['address'] }}:2379{% if not loop.last %},{% endif %}{% endfor %}"
      export ETCDCTL_CACERT="/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt"
      export ETCDCTL_CERT="/var/lib/rancher/k3s/server/tls/etcd/client.crt"
      export ETCDCTL_KEY="/var/lib/rancher/k3s/server/tls/etcd/client.key"

    owner: "{{ dotfiles_user | default(ansible_user_id | default('root')) }}"
    group: "{{ dotfiles_user | default(ansible_user_id | default('root')) }}"
    mode: "0644"
    backup: yes
  tags: [dotfiles]
