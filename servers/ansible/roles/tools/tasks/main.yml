---
- name: Enable EPEL repository
  ansible.builtin.dnf:
    name: epel-release
    state: present
  become: true
  ignore_errors: true
  tags: [tools]

- name: Ensure monitoring and network tools are installed
  ansible.builtin.dnf:
    name:
      - bat
      - btop
      - wireguard-tools
      - htop
      - nmap
      - iscsi-initiator-utils
      - tar
      - net-tools
      - nfs-utils
    state: present
  become: true
  tags: [tools]
  retries: 3
  delay: 10

- name: Check if grc is available in repos
  ansible.builtin.command: dnf info grc
  register: grc_repo_check
  failed_when: false
  changed_when: false
  tags: [tools]

- name: Install grc from repo if available
  ansible.builtin.dnf:
    name: grc
    state: present
  when: grc_repo_check.rc == 0
  become: true
  tags: [tools]

- name: Install grc from custom RPM if repo unavailable and URL provided
  block:
    - name: Check if grc is already installed
      ansible.builtin.command: rpm -q grc
      register: grc_installed_check
      failed_when: false
      changed_when: false

    - name: Download grc RPM
      ansible.builtin.get_url:
        url: "{{ grc_rpm_url }}"
        dest: "/tmp/{{ grc_rpm_url | basename }}"
        mode: "0644"
      when: grc_installed_check.rc != 0
      become: true

    - name: Install grc from downloaded RPM
      ansible.builtin.dnf:
        name: "/tmp/{{ grc_rpm_url | basename }}"
        state: present
        disable_gpg_check: true
      when: grc_installed_check.rc != 0
      become: true
  when: grc_repo_check.rc != 0 and grc_rpm_url is defined
  tags: [tools]

- name: Install ELRepo repository
  ansible.builtin.dnf:
    name: "{{ elrepo_rpm_url | default('https://www.elrepo.org/elrepo-release-10.el10.elrepo.noarch.rpm') }}"
    state: present
    disable_gpg_check: true
  become: true
  tags: [tools]

- name: Install latest mainline kernel
  ansible.builtin.dnf:
    name: kernel-ml
    state: present
    enablerepo: elrepo-kernel
  become: true
  tags: [tools]

- name: Check if etcd is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/etcd
  register: etcd_installed
  tags: [tools]

- name: Check if etcdctl is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/etcdctl
  register: etcdctl_installed
  tags: [tools]

- name: Check if etcdutl is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/etcdutl
  register: etcdutl_installed
  tags: [tools]

- name: Install etcd, etcdctl and etcdutl from GitHub releases
  when: not etcd_installed.stat.exists or not etcdctl_installed.stat.exists or not etcdutl_installed.stat.exists
  tags: [tools]
  block:
    - name: Download etcd binary archive
      ansible.builtin.get_url:
        url: "https://github.com/etcd-io/etcd/releases/download/v{{ etcd_version | default('3.6.7') }}/etcd-v{{ etcd_version | default('3.6.7') }}-linux-amd64.tar.gz"
        dest: "/tmp/etcd-v{{ etcd_version | default('3.6.7') }}-linux-amd64.tar.gz"
        mode: "0644"
      become: true

    - name: Extract etcd archive
      ansible.builtin.unarchive:
        src: "/tmp/etcd-v{{ etcd_version | default('3.6.7') }}-linux-amd64.tar.gz"
        dest: /tmp/
        remote_src: true
      become: true

    - name: Install etcd binary
      ansible.builtin.copy:
        src: "/tmp/etcd-v{{ etcd_version | default('3.6.7') }}-linux-amd64/etcd"
        dest: /usr/local/bin/etcd
        mode: "0755"
        remote_src: true
      become: true

    - name: Install etcdctl binary
      ansible.builtin.copy:
        src: "/tmp/etcd-v{{ etcd_version | default('3.6.7') }}-linux-amd64/etcdctl"
        dest: /usr/local/bin/etcdctl
        mode: "0755"
        remote_src: true
      become: true

    - name: Install etcdutl binary
      ansible.builtin.copy:
        src: "/tmp/etcd-v{{ etcd_version | default('3.6.7') }}-linux-amd64/etcdutl"
        dest: /usr/local/bin/etcdutl
        mode: "0755"
        remote_src: true
      become: true

    - name: Clean up etcd archive
      ansible.builtin.file:
        path: "/tmp/etcd-v{{ etcd_version | default('3.6.7') }}-linux-amd64.tar.gz"
        state: absent
      become: true

    - name: Clean up etcd extracted directory
      ansible.builtin.file:
        path: "/tmp/etcd-v{{ etcd_version | default('3.6.7') }}-linux-amd64"
        state: absent
      become: true
