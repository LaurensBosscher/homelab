# Copilot Repository Instructions

This repository contains configuration and deployment files for a multi-region Kubernetes homelab cluster running on K3s.

## Repository Overview

This is an Infrastructure as Code (IaC) repository that manages:
- **Kubernetes manifests**: Application deployments in the `apps/` directory
- **Ansible playbooks**: Server configuration in the `servers/ansible/` directory
- **Documentation**: Screenshots and guides in the `docs/` directory

### Technology Stack
- **Kubernetes**: K3s distribution with 6 nodes across 4 regions
- **GitOps CD**: ArgoCD for continuous deployment
- **Storage**: Longhorn for distributed block storage
- **Networking**: Wireguard with Tailscale, Cloudflare Tunnels for ingress
- **Configuration Management**: Ansible for server provisioning
- **Dependency Management**: Mend Renovate for automated updates

## Directory Structure

- `apps/`: Kubernetes application manifests organized by application name
  - Each app directory contains deployment, service, PVC, and config YAML files
  - ArgoCD automatically deploys changes from this directory
- `servers/ansible/`: Ansible configuration for node setup and management
  - `hosts.ini`: Inventory of cluster nodes
  - `roles/`: Ansible roles for server configuration
  - `site.yml`: Main playbook
- `docs/`: Documentation and screenshots
- `renovate.json`: Configuration for automated dependency updates

## Build & Deployment

### There is no traditional "build" process
This repository contains declarative configuration files (YAML) that are:
1. **Kubernetes manifests** deployed via ArgoCD GitOps pipeline
2. **Ansible playbooks** executed manually on servers

### Deployment Process
- **Applications**: Push changes to `apps/` directory â†’ ArgoCD automatically deploys to the cluster
- **Infrastructure**: Run Ansible playbooks manually:
  ```bash
  cd servers/ansible
  ansible-playbook -i hosts.ini site.yml -u root --private-key ~/.ssh/id_rsa_kubernetes
  ```

## Code Standards & Conventions

### Kubernetes Manifests
- Use YAML format (both `.yml` and `.yaml` extensions are acceptable)
- Follow Kubernetes API conventions and best practices
- Include resource limits and requests in deployments
- Use node affinity for geographical placement when needed
- Organize files by application in separate directories under `apps/`
- Include proper labels: `app.kubernetes.io/name` for app identification

### Image Tags
- Use specific version tags (e.g., `V1.5`, `v14`) rather than `latest`
- Renovate automatically creates PRs for image updates
- All container images are specified in deployment YAML files

### Secrets
- **NEVER** commit secrets to this repository
- Secrets are encrypted in the cluster and managed separately
- Use placeholders or references in committed files

### File Naming
- Kubernetes files: `<app-name>-<resource-type>.yml` (e.g., `homepage-deployment.yml`)
- Ansible files: Follow standard Ansible conventions

### Homepage
- Check if the app already exists in apps/homepage/homepage-config.yml, if not add a new entry following existing format
- link: should be in the format service name (e.g stremio).bosscher.ch
- set siteMonitor: to the health check URL of the app, if applicable
- set ping: if siteMonitor is not applicable or if the app does not offer an http endpoint (e.g a UDP DNS service)

## Testing & Validation

### Kubernetes Manifests
- Validate YAML syntax before committing
- Use `kubectl apply --dry-run=client -f <file>` to validate manifests
- Test in a non-production namespace first when possible

### Ansible Playbooks
- Validate syntax with `ansible-playbook --syntax-check`
- Use `--check` mode for dry runs before actual deployment

## Important Notes for Code Changes

1. **Minimal Changes**: This is a production homelab cluster - make surgical, focused changes
2. **No Breaking Changes**: Applications are running 24/7 - avoid changes that cause downtime
3. **ArgoCD Auto-Deployment**: Changes to `apps/` are automatically deployed - be careful!
4. **Renovate PRs**: Many PRs are auto-generated by Renovate for dependency updates
5. **Node Management**: SSH access is only via Tailscale interface for security

## Common Tasks

### Adding a New Application
1. Create a new directory under `apps/<app-name>/`
2. Add deployment, service, and PVC YAML files
3. Configure resource requests/limits
4. Add node affinity if geographical placement is needed
5. ArgoCD will automatically deploy the new application

### Updating an Application
1. Modify the relevant YAML files in `apps/<app-name>/`
2. Update image tags or configuration as needed
3. Commit changes - ArgoCD handles deployment

### Adding a New Node
1. Update `servers/ansible/hosts.ini` with new node details
2. Follow the process documented in README.md
3. Run Ansible playbook to configure the node
4. Join the node to the K3s cluster

## Documentation Requirements

- Update README.md when adding new applications to the "Apps" section
- Document any significant infrastructure changes
- Keep hardware inventory table updated when nodes change
- Add screenshots to `docs/` for visual documentation

## Support for Code Review

When submitting changes:
- Explain the purpose and impact of changes
- Reference any related issues
- Note if changes affect running applications
- Indicate if manual testing was performed
